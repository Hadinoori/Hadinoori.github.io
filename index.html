<section class="insights-section" aria-labelledby="insights-heading">
    <h2 id="insights-heading" class="section-label">Selected Insights</h2>
    <div id="insights-container">
        <div class="entry">
            <div class="meta-spine">STATUS</div>
            <div class="entry-content">
                <h3 class="entry-title">Connecting to dispatch archive...</h3>
            </div>
        </div>
    </div>
</section>

<script>
    async function syncInsights() {
        const container = document.getElementById('insights-container');
        const REPO = 'hadinoori/hadinoori.github.io';
        
        try {
            // Fetch file list from GitHub
            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/_insights`);
            if (!res.ok) throw new Error('Failed to fetch repository contents');
            
            const files = await res.json();
            const mdFiles = files.filter(f => f.name.endsWith('.md')).reverse();
            
            let htmlBuffer = '';
            let foundAny = false;

            for (const file of mdFiles) {
                const fileRes = await fetch(file.download_url);
                const raw = await fileRes.text();
                
                // Enhanced robust parser for Frontmatter
                const parseField = (key) => {
                    const regex = new RegExp(`${key}:\\s*["']?(.*?)["']?(\\n|\\r|$)`, 'i');
                    const match = raw.match(regex);
                    return match ? match[1].trim() : null;
                };

                const isSelected = parseField('selected_dispatch');
                
                // Check for both string "true" and literal true from CMS
                if (isSelected === 'true' || isSelected === true) {
                    foundAny = true;
                    const title = parseField('title') || "Untitled Dispatch";
                    const dateRaw = parseField('date');
                    const desc = parseField('description') || "";
                    const extUrl = parseField('external_url');
                    
                    const displayDate = dateRaw 
                        ? new Date(dateRaw).toLocaleDateString('en-US', {month:'short', year:'numeric'}).toUpperCase()
                        : "RECENT";

                    const isExternal = extUrl && extUrl !== '""' && extUrl !== 'null';
                    const link = isExternal ? extUrl : `insights/${file.name.replace('.md', '.html')}`;
                    const target = isExternal ? 'target="_blank" rel="noopener noreferrer"' : '';

                    htmlBuffer += `
                        <article class="entry">
                            <div class="meta-spine">
                                <span class="year">${displayDate}</span>
                                <span class="tag">Insight</span>
                            </div>
                            <div class="entry-content">
                                <h3 class="entry-title"><a href="${link}" ${target}>${title}</a></h3>
                                <p class="entry-desc">${desc}</p>
                            </div>
                        </article>
                    `;
                }
            }
            
            container.innerHTML = foundAny ? htmlBuffer : `
                <div class="entry">
                    <div class="meta-spine">EMPTY</div>
                    <div class="entry-content"><h3 class="entry-title">No selected dispatches found in the archive.</h3></div>
                </div>`;
            
        } catch (e) { 
            console.error("Sync Error:", e);
            container.innerHTML = `
                <div class="entry">
                    <div class="meta-spine">ERROR</div>
                    <div class="entry-content"><h3 class="entry-title">System offline. Please check back later.</h3></div>
                </div>`;
        }
    }
    window.addEventListener('DOMContentLoaded', syncInsights);
</script>
