<section class="insights-section" aria-labelledby="insights-heading">
    <h2 id="insights-heading" class="section-label">Selected Insights</h2>
    <div id="insights-container">
        <div class="entry-loading">Syncing archive...</div>
    </div>
</section>

<script>
    async function syncInsights() {
        const container = document.getElementById('insights-container');
        const REPO = 'hadinoori/hadinoori.github.io';
        
        try {
            // 6: Simple session caching (Optional but recommended)
            const cachedData = sessionStorage.getItem('insights_data');
            if (cachedData) {
                renderInsights(JSON.parse(cachedData));
            }

            const res = await fetch(`https://api.github.com/repos/${REPO}/contents/_insights`);
            const files = await res.json();
            
            // 2: Sorting logic based on naming convention
            const sortedFiles = files.filter(f => f.name.endsWith('.md')).reverse();
            const insightsData = [];

            for (const file of sortedFiles) {
                const fileRes = await fetch(file.download_url);
                const raw = await fileRes.text();
                
                const getValue = (key) => {
                    const regex = new RegExp(`${key}:\\s*["']?(.*?)["']?(\\n|$)`, 'i');
                    const match = raw.match(regex);
                    return match ? match[1].trim() : "";
                };

                if (getValue('selected_dispatch') === 'true') {
                    insightsData.push({
                        title: getValue('title') || "Untitled",
                        date: getValue('date'),
                        desc: getValue('description'),
                        url: getValue('external_url'),
                        filename: file.name
                    });
                }
            }
            
            sessionStorage.setItem('insights_data', JSON.stringify(insightsData));
            renderInsights(insightsData);
            
        } catch (e) { 
            console.error("Sync Error:", e);
            container.innerHTML = '<div class="entry-status">Unable to reach the archive.</div>';
        }
    }

    function renderInsights(data) {
        const container = document.getElementById('insights-container');
        if (data.length === 0) {
            container.innerHTML = '<div class="entry-status">No selected dispatches found.</div>';
            return;
        }

        container.innerHTML = data.map(item => {
            const displayDate = item.date 
                ? new Date(item.date).toLocaleDateString('en-US', {month:'short', year:'numeric'}).toUpperCase()
                : "RECENT";

            // 4: target="_blank" logic for external links
            const isExternal = item.url && item.url !== '""';
            const link = isExternal ? item.url : `insights/${item.filename.replace('.md', '.html')}`;
            const target = isExternal ? 'target="_blank" rel="noopener noreferrer"' : '';

            return `
                <article class="entry">
                    <div class="meta-spine">
                        <span class="year">${displayDate}</span>
                        <span class="tag">Insight</span>
                    </div>
                    <div class="entry-content">
                        <h3 class="entry-title"><a href="${link}" ${target}>${item.title}</a></h3>
                        <p class="entry-desc">${item.desc}</p>
                    </div>
                </article>
            `;
        }).join('');
    }

    window.addEventListener('DOMContentLoaded', syncInsights);
</script>
