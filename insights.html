<script>
async function loadInsights() {
    const container = document.getElementById('insights-container');
    const REPO = 'hadinoori/hadinoori.github.io';
    
    try {
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/_insights`);
        const files = await res.json();
        
        // Filter Markdown files and reverse order
        const mdFiles = files.filter(f => f.name.endsWith('.md')).reverse();

        container.innerHTML = ''; 

        for (let file of mdFiles) {
            const fRes = await fetch(file.download_url);
            const text = await fRes.text();
            
            // Metadata extraction
            const titleMatch = text.match(/title:\s*["']?(.*?)["']?$/m);
            const title = titleMatch ? titleMatch[1] : "Strategic Inquiry";
            
            const dateMatch = text.match(/date:\s*(.*)/);
            const date = dateMatch ? dateMatch[1] : "";
            
            const descMatch = text.match(/description:\s*["']?(.*?)["']?$/m);
            const desc = descMatch ? descMatch[1] : "";

            const extUrlMatch = text.match(/external_url:\s*["']?(.*?)["']?$/m);
            const externalUrl = extUrlMatch ? extUrlMatch[1] : null;

            // --- THE 404 FIX ---
            // If Jekyll processes the files, the URL is usually /insights/filename (without .html)
            // or /insights/filename.html. We will use the direct relative path.
            const cleanName = file.name.replace('.md', '');
            const finalLink = externalUrl ? externalUrl : `./${cleanName}.html`;
            // --------------------

            const displayDate = new Date(date).toLocaleDateString('en-US', {
                month: 'short', year: 'numeric'
            }).toUpperCase();

            container.innerHTML += `
                <div style="border-bottom: 1px solid var(--ui-border);">
                    <div class="entry">
                        <div class="meta-spine">${displayDate} / ${externalUrl ? 'DISPATCH' : 'INSIGHT'}</div>
                        <div class="item-body">
                            <h3 class="entry-title">
                                <a href="${finalLink}" ${externalUrl ? 'target="_blank"' : ''} style="text-decoration:none; color:inherit;">
                                    ${title} ${externalUrl ? 'â†—' : ''}
                                </a>
                            </h3>
                            <p style="color: var(--text-muted); font-size: 1.1rem; max-width: 52ch; margin:0; line-height: 1.6;">
                                ${desc}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
    } catch (e) {
        console.error("Archive synchronization failed:", e);
    }
}
window.onload = loadInsights;
</script>
